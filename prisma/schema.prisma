generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Models
model Patient {
  id           Int       @id @default(autoincrement())
  firstName    String
  lastName     String?
  fullName     String // Pre-computed for easier querying
  gender       String
  age          Int?
  dateOfBirth  DateTime?
  guardianName String? // For infertility patients, this is spouse name
  address      String?
  phoneNumber  String?
  email        String?
  bloodGroup   String?

  // Spouse information (primarily for infertility patients)
  spouseAge    Int?
  spouseDOB    DateTime?
  spouseGender String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int // Staff ID who created the record

  // Relations
  admissions         Admission[]
  pathologyTests     PathologyTest[]
  account            PatientAccount? // Central account for all charges/payments
  infertilityRecords InfertilityPatient[] // Infertility department records

  @@index([fullName])
  @@index([phoneNumber])
}

model Department {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  // Relations
  staffAssignments StaffDepartment[]
  admissions       Admission[]
  pathologyTests   PathologyTest[]
  serviceCharges   ServiceCharge[] // New relation
}

model Staff {
  id             Int      @id @default(autoincrement())
  firstName      String
  lastName       String
  fullName       String
  role           String // Doctor, Nurse, PIC, Admin, etc.
  specialization String?
  phoneNumber    String?
  email          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  departmentAssignments StaffDepartment[]
  supervisedAdmissions  Admission[]       @relation("AdmittingDoctor")
  collectedPayments     Payment[]
  pathologyOrderedBy    PathologyTest[]   @relation("OrderedBy")
  pathologyDoneBy       PathologyTest[]   @relation("DoneBy")
  shifts                Shift[] // New relation for cash management

  // Infertility relations
  infertilityCreated  InfertilityPatient[] @relation("InfertilityCreatedBy")
  infertilityModified InfertilityPatient[] @relation("InfertilityModifiedBy")

  // Login credentials
  user User?

  @@index([fullName])
}

model StaffDepartment {
  id           Int     @id @default(autoincrement())
  staffId      Int
  departmentId Int
  isPrimary    Boolean @default(false)

  staff      Staff      @relation(fields: [staffId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])

  @@unique([staffId, departmentId])
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  staffId   Int      @unique
  role      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  staff        Staff         @relation(fields: [staffId], references: [id])
  sessions     Session[]
  activityLogs ActivityLog[]
  csrfTokens   CSRFToken[]
  securityLogs SecurityLog[]
}

// CSRF Token Management for Session Security
model CSRFToken {
  id        String   @id @default(cuid())
  userId    Int
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

// Gynecology Department
model Admission {
  id              Int       @id @default(autoincrement())
  patientId       Int
  departmentId    Int
  admissionNumber String    @unique
  doctorId        Int
  dateAdmitted    DateTime  @default(now())
  dateDischarged  DateTime?
  isDischarged    Boolean   @default(false)

  // Financial
  admissionFee   Decimal @default(0)
  serviceCharge  Decimal @default(0)
  seatRent       Decimal @default(0)
  otCharge       Decimal @default(0)
  medicineCharge Decimal @default(0)
  otherCharges   Decimal @default(0)

  totalAmount    Decimal @default(0)
  discountAmount Decimal @default(0)
  grandTotal     Decimal @default(0)
  paidAmount     Decimal @default(0) // Sum of all payments
  dueAmount      Decimal @default(0) // Calculated: grandTotal - paidAmount
  initialPayment Decimal @default(0) // First payment at admission

  // Room details
  seatNumber String?
  ward       String?

  // Medical details
  diagnosis String?
  otType    String?
  treatment String?
  remarks   String?

  // Tracking
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      Int
  lastModifiedBy Int

  // Relations
  patient        Patient         @relation(fields: [patientId], references: [id])
  department     Department      @relation(fields: [departmentId], references: [id])
  doctor         Staff           @relation("AdmittingDoctor", fields: [doctorId], references: [id])
  pathologyTests PathologyTest[]
  serviceCharges ServiceCharge[] // Link to new payment system

  @@index([patientId])
  @@index([departmentId])
  @@index([doctorId])
  @@index([dateAdmitted])
  @@index([isDischarged])
}

// Pathology Department
model PathologyTest {
  id           Int    @id @default(autoincrement())
  patientId    Int
  departmentId Int
  testNumber   String @unique
  admissionId  Int? // Optional link to admission if patient is admitted
  orderedById  Int // Doctor who ordered the test
  doneById     Int? // Staff who performed the test

  // Test info
  testDate     DateTime  @default(now())
  reportDate   DateTime?
  testCategory String // Blood, Urine, X-ray, etc.
  testResults  Json? // Store test name, value, normal range, etc.
  remarks      String?
  isCompleted  Boolean   @default(false)

  // Financial
  testCharge     Decimal @default(0)
  discountAmount Decimal @default(0)
  grandTotal     Decimal @default(0)
  paidAmount     Decimal @default(0) // Sum of all payments
  dueAmount      Decimal @default(0) // Calculated: grandTotal - paidAmount
  initialPayment Decimal @default(0) // First payment when test ordered

  // Tracking
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      Int
  lastModifiedBy Int

  // Relations
  patient        Patient         @relation(fields: [patientId], references: [id])
  department     Department      @relation(fields: [departmentId], references: [id])
  admission      Admission?      @relation(fields: [admissionId], references: [id])
  orderedBy      Staff           @relation("OrderedBy", fields: [orderedById], references: [id])
  doneBy         Staff?          @relation("DoneBy", fields: [doneById], references: [id])
  serviceCharges ServiceCharge[] // Link to new payment system

  @@index([patientId])
  @@index([departmentId])
  @@index([admissionId])
  @@index([orderedById])
  @@index([testDate])
}

// Enhanced Payment & Cash Management System

// Staff Shift Management
model Shift {
  id        Int       @id @default(autoincrement())
  staffId   Int
  startTime DateTime
  endTime   DateTime?
  isActive  Boolean   @default(true)

  // Cash reconciliation
  openingCash Decimal @default(0) // Cash at start of shift
  closingCash Decimal @default(0) // Physical cash at end
  systemCash  Decimal @default(0) // What system says they should have (sum of payments collected)
  variance    Decimal @default(0) // Difference between closing and system

  // Detailed tracking
  totalCollected Decimal @default(0) // Total amount collected in shift
  totalRefunded  Decimal @default(0) // Total refunds given in shift

  // Reconciliation details
  notes              String?
  reconciledAt       DateTime?
  reconciledBy       Int? // Staff ID who reconciled
  reconciledNotes    String? // Notes from reconciliation
  varianceResolution String? // How variance was handled (e.g., "Noted", "Corrected", "Pending")

  // Relations
  staff         Staff          @relation(fields: [staffId], references: [id])
  payments      Payment[]
  cashMovements CashMovement[]

  @@index([staffId])
  @@index([startTime])
  @@index([isActive])
  @@index([reconciledAt])
}

// Track all cash movements for accountability
model CashMovement {
  id           Int      @id @default(autoincrement())
  shiftId      Int
  amount       Decimal
  movementType String // "COLLECTION", "REFUND", "TRANSFER", "RECONCILIATION", "CORRECTION"
  description  String?
  timestamp    DateTime @default(now())

  // Link to specific transaction if applicable
  paymentId Int? // Link to payment if this is a collection
  notes     String? // Additional notes about the movement

  // Tracking
  createdBy  Int // Staff who recorded this movement
  approvedBy Int? // Staff who approved if required
  approvedAt DateTime?

  // Relations
  shift   Shift    @relation(fields: [shiftId], references: [id])
  payment Payment? @relation(fields: [paymentId], references: [id])

  @@index([shiftId])
  @@index([timestamp])
  @@index([movementType])
  @@index([paymentId])
}

// Central Patient Account for all charges across departments
model PatientAccount {
  id             Int     @id @default(autoincrement())
  patientId      Int     @unique
  totalCharges   Decimal @default(0) // Sum of all service charges
  totalPaid      Decimal @default(0) // Sum of all payments
  totalDue       Decimal @default(0) // Calculated: totalCharges - totalPaid
  advanceBalance Decimal @default(0) // If patient pays in advance

  // Relations
  patient        Patient         @relation(fields: [patientId], references: [id])
  serviceCharges ServiceCharge[]
  payments       Payment[]

  @@index([patientId])
}

// Individual service charges (more granular than admission/pathology)
model ServiceCharge {
  id               Int    @id @default(autoincrement())
  patientAccountId Int
  serviceType      String // "ADMISSION_FEE", "PATHOLOGY_TEST", "OPERATION", "MEDICINE", etc.
  serviceName      String // Specific name like "LUCS Operation", "Blood Test"
  departmentId     Int

  // Financial details
  originalAmount Decimal
  discountAmount Decimal @default(0)
  finalAmount    Decimal // originalAmount - discountAmount

  // Service details
  serviceDate DateTime @default(now())
  description String?

  // Collection tracking
  collectedByStaffId Int? // Staff who collected payment for this service (if any)
  collectionTime     DateTime? // When payment was collected
  collectionNotes    String? // Notes about collection

  // Links to specific services if needed
  admissionId     Int?
  pathologyTestId Int?

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int

  // Relations
  patientAccount     PatientAccount      @relation(fields: [patientAccountId], references: [id])
  department         Department          @relation(fields: [departmentId], references: [id])
  admission          Admission?          @relation(fields: [admissionId], references: [id])
  pathologyTest      PathologyTest?      @relation(fields: [pathologyTestId], references: [id])
  paymentAllocations PaymentAllocation[]

  @@index([patientAccountId])
  @@index([departmentId])
  @@index([serviceType])
  @@index([serviceDate])
}

// Enhanced Payment Model
model Payment {
  id               Int      @id @default(autoincrement())
  patientAccountId Int // Always linked to patient account
  amount           Decimal
  paymentMethod    String // Cash, Card, etc.
  paymentDate      DateTime @default(now())
  collectedById    Int
  shiftId          Int // Which shift collected this

  receiptNumber String  @unique
  notes         String?

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientAccount     PatientAccount      @relation(fields: [patientAccountId], references: [id])
  collector          Staff               @relation(fields: [collectedById], references: [id])
  shift              Shift               @relation(fields: [shiftId], references: [id])
  paymentAllocations PaymentAllocation[] // How this payment is split across services
  cashMovements      CashMovement[]

  @@index([patientAccountId])
  @@index([collectedById])
  @@index([shiftId])
  @@index([paymentDate])
}

// Track how payments are allocated to specific charges
model PaymentAllocation {
  id              Int     @id @default(autoincrement())
  paymentId       Int
  serviceChargeId Int
  allocatedAmount Decimal

  payment       Payment       @relation(fields: [paymentId], references: [id])
  serviceCharge ServiceCharge @relation(fields: [serviceChargeId], references: [id])

  @@index([paymentId])
  @@index([serviceChargeId])
}

// Session & Activity Tracking
model Session {
  id        String   @id @default(cuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Device tracking fields
  ipAddress           String?
  userAgent           String?
  deviceFingerprint   String? // Hash of key device identifiers
  readableFingerprint String? // Human-readable format like AA:BB:CC:DD:EE:FF
  osType              String? // The basic OS type (Windows, macOS, iOS, Android)
  browserName         String? // Chrome, Firefox, Safari, etc.
  browserVersion      String? // Browser version only
  deviceType          String? // Mobile, Tablet, Desktop

  // Relations
  user       User          @relation(fields: [userId], references: [id])
  activities ActivityLog[]

  @@index([userId])
  @@index([deviceFingerprint])
  @@index([readableFingerprint])
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  action      String
  description String?
  entityType  String? // Patient, Admission, Payment, etc.
  entityId    Int? // ID of the affected entity
  timestamp   DateTime @default(now())
  ipAddress   String?

  // Session relation for active sessions
  sessionId String?
  session   Session? @relation(fields: [sessionId], references: [id])

  // Device info preserved for historical records
  deviceFingerprint   String?
  readableFingerprint String?
  deviceType          String?
  browserName         String?
  browserVersion      String?
  osType              String?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([timestamp])
  @@index([entityType, entityId])
  @@index([sessionId])
  @@index([deviceFingerprint])
  @@index([readableFingerprint])
}

// Configuration
model HospitalConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   Int
}

// Hospital/Medical Institution Model
model Hospital {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  address     String?
  phoneNumber String?
  email       String?
  website     String?
  type        String? // "Government", "Private", "Clinic", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int // Staff ID who created the record

  // Relations
  infertilityPatients InfertilityPatient[]

  @@index([name])
}

// Security: Rate Limiting for Login Attempts
model RateLimit {
  id             Int      @id @default(autoincrement())
  ip_address     String   @unique
  login_attempts Int      @default(0)
  window_start   DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([ip_address])
  @@index([window_start])
}

// Security: IP Blocking (Temporary & Permanent)
model BlockedIP {
  id             Int       @id @default(autoincrement())
  ip_address     String    @unique
  reason         String // Reason for blocking
  description    String?
  blocked_at     DateTime  @default(now())
  blocked_until  DateTime? // Null if permanent
  is_permanent   Boolean   @default(false)
  user_agent     String? // User agent when blocked
  attempt_count  Int       @default(0) // Failed attempts before block
  unblocked_by   Int? // Staff ID who unblocked (manual unblock)
  unblocked_at   DateTime? // When manually unblocked
  unblock_reason String? // Reason for manual unblock

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ip_address])
  @@index([blocked_until])
  @@index([is_permanent])
  @@index([blocked_at])
}

// Security: Audit Log for Security Events
model SecurityLog {
  id          Int      @id @default(autoincrement())
  ip_address  String
  action      String // LOGIN_FAILED, RATE_LIMIT_BLOCK, SUSPICIOUS_ACTIVITY, CSRF_ATTEMPT, etc.
  user_agent  String?
  description String
  severity    String // LOW, MEDIUM, HIGH, CRITICAL
  timestamp   DateTime @default(now())

  // Optional: Link to user if known
  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  @@index([ip_address])
  @@index([action])
  @@index([severity])
  @@index([timestamp])
  @@index([userId])
}

model InfertilityPatient {
  id Int @id @default(autoincrement())

  // References to central tables
  patientId  Int // Links to main Patient table
  hospitalId Int // Hospital where treatment happens

  // Marriage & Fertility History
  yearsMarried    Int? // How many years married
  yearsTrying     Int? // How many years trying to conceive
  infertilityType String? // "Primary" or "Secondary"

  // Medical Information specific to infertility
  para          String? // Obstetric history notation (e.g., "0+1ab, 2c/s")
  gravida       String? // Number of pregnancies
  weight        Decimal? // Patient's weight
  height        Decimal? // Patient's height in cm
  bmi           Decimal? // Body Mass Index
  bloodPressure String? // Blood pressure reading
  bloodGroup    String? // Blood type

  // Medical History
  medicalHistory       String? // Previous medical conditions
  surgicalHistory      String? // Previous surgeries
  menstrualHistory     String? // Menstrual cycle details
  contraceptiveHistory String? // Previous contraceptive use

  // Current Visit Information
  referralSource String? // How patient was referred
  chiefComplaint String? // Main reason for visit

  // Treatment Information
  treatmentPlan String? // Proposed treatment approach
  medications   String? // Current medications

  // Follow-up
  nextAppointment DateTime?
  status          String?   @default("Active") // "Active", "Completed", "Discontinued"

  // Additional fields
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      Int // Staff ID who created the record
  lastModifiedBy Int? // Staff ID who last modified

  // Relations
  patient         Patient  @relation(fields: [patientId], references: [id])
  hospital        Hospital @relation(fields: [hospitalId], references: [id])
  createdByStaff  Staff    @relation("InfertilityCreatedBy", fields: [createdBy], references: [id])
  modifiedByStaff Staff?   @relation("InfertilityModifiedBy", fields: [lastModifiedBy], references: [id])

  @@unique([patientId, hospitalId]) // One infertility record per patient per hospital
  @@index([patientId])
  @@index([hospitalId])
  @@index([createdAt])
  @@index([status])
}
